<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>CommonSecurityRules.kt</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">app</a> &gt; <a href="index.source.html" class="el_package">org.vaccineimpact.api.app.security</a> &gt; <span class="el_source">CommonSecurityRules.kt</span></div><h1>CommonSecurityRules.kt</h1><pre class="source lang-java linenums">package org.vaccineimpact.api.app.security

import org.vaccineimpact.api.app.context.ActionContext
import org.vaccineimpact.api.app.errors.UnknownObjectError
import org.vaccineimpact.api.app.repositories.BurdenEstimateRepository
import org.vaccineimpact.api.models.Scope
import org.vaccineimpact.api.models.Touchstone
import org.vaccineimpact.api.models.TouchstoneStatus
import org.vaccineimpact.api.models.TouchstoneVersion
import org.vaccineimpact.api.models.permissions.ReifiedPermission

fun ActionContext.checkIsAllowedToSeeTouchstone(touchstoneVersionId: String, touchstoneStatus: TouchstoneStatus)
{
<span class="fc" id="L14">    val permission = ReifiedPermission(&quot;touchstones.prepare&quot;, Scope.Global())</span>
<span class="fc bfc" id="L15" title="All 4 branches covered.">    if (touchstoneStatus == TouchstoneStatus.IN_PREPARATION &amp;&amp; !this.hasPermission(permission))</span>
    {
<span class="fc" id="L17">        throw UnknownObjectError(touchstoneVersionId, TouchstoneVersion::class)</span>
    }
<span class="fc" id="L19">}</span>

fun ActionContext.isAllowedToSeeTouchstoneVersion(touchstoneVersion: TouchstoneVersion): Boolean
{
<span class="fc" id="L23">    val permission = ReifiedPermission(&quot;touchstones.prepare&quot;, Scope.Global())</span>
<span class="fc bfc" id="L24" title="All 4 branches covered.">    return this.hasPermission(permission)</span>
            || touchstoneVersion.status != TouchstoneStatus.IN_PREPARATION
}

<span class="fc" id="L28">fun List&lt;Touchstone&gt;.filterByPermission(context: ActionContext) = this</span>
<span class="fc" id="L29">        .map { it.copy(versions = it.versions.filterByPermission(context)) }</span>
<span class="fc bfc" id="L30" title="All 2 branches covered.">        .filter { it.versions.any() }</span>
<span class="fc" id="L31">        .toList()</span>

@JvmName(&quot;filterTouchstoneVersionByPermission&quot;)
private fun List&lt;TouchstoneVersion&gt;.filterByPermission(context: ActionContext) =
<span class="fc bfc" id="L35" title="All 2 branches covered.">        this.filter { context.isAllowedToSeeTouchstoneVersion(it) }</span>

fun ActionContext.getAllowableTouchstoneStatusList(): List&lt;TouchstoneStatus&gt;
{
<span class="fc" id="L39">    val result =  mutableListOf&lt;TouchstoneStatus&gt;(TouchstoneStatus.FINISHED, TouchstoneStatus.OPEN)</span>
<span class="fc bfc" id="L40" title="All 2 branches covered.">    if (this.hasPermission(ReifiedPermission(&quot;touchstones.prepare&quot;, Scope.Global())))</span>
    {
<span class="fc" id="L42">        result.add(TouchstoneStatus.IN_PREPARATION)</span>
    }
<span class="fc" id="L44">    return result</span>
}

fun ActionContext.checkEstimatePermissionsForTouchstoneVersion(
        groupId: String,
        touchstoneVersionId: String,
        estimateRepository: BurdenEstimateRepository,
<span class="fc" id="L51">        readEstimatesRequired: Boolean = false</span>
)
{
<span class="fc" id="L54">    val versions = estimateRepository.touchstoneRepository.touchstoneVersions</span>
<span class="fc" id="L55">    val touchstoneVersion = versions.get(touchstoneVersionId)</span>
<span class="fc" id="L56">    this.checkIsAllowedToSeeTouchstone(touchstoneVersionId, touchstoneVersion.status)</span>
<span class="pc bpc" id="L57" title="1 of 2 branches missed.">    if (readEstimatesRequired)</span>
    {
<span class="nc bnc" id="L59" title="All 2 branches missed.">        if (touchstoneVersion.status == TouchstoneStatus.OPEN)</span>
        {
<span class="nc" id="L61">            this.requirePermission(ReifiedPermission(</span>
<span class="nc" id="L62">                    &quot;estimates.read-unfinished&quot;,</span>
<span class="nc" id="L63">                    Scope.Specific(&quot;modelling-group&quot;, groupId)</span>
            ))
        }
    }
<span class="fc" id="L67">}</span>
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.3.201901230119</span></div></body></html>