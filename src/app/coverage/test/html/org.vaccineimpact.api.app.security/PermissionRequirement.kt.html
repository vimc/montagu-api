<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>PermissionRequirement.kt</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">app</a> &gt; <a href="index.source.html" class="el_package">org.vaccineimpact.api.app.security</a> &gt; <span class="el_source">PermissionRequirement.kt</span></div><h1>PermissionRequirement.kt</h1><pre class="source lang-java linenums">package org.vaccineimpact.api.app.security

import org.vaccineimpact.api.app.context.ActionContext
import org.vaccineimpact.api.app.errors.PermissionRequirementParseException
import org.vaccineimpact.api.models.Scope
import org.vaccineimpact.api.models.permissions.ReifiedPermission

<span class="pc" id="L8">data class PermissionRequirement(val name: String, val scopeRequirement: ScopeRequirement)</span>
{
<span class="nc" id="L10">    fun reify(context: ActionContext) = ReifiedPermission(name, scopeRequirement.reify(context))</span>

<span class="nc" id="L12">    override fun toString() = &quot;$scopeRequirement/$name&quot;</span>

    companion object
    {
        fun parse(raw: String): PermissionRequirement
        {
<span class="fc" id="L18">            try</span>
            {
<span class="fc" id="L20">                val parts = raw.split('/')</span>
<span class="fc" id="L21">                val rawScope = parts[0]</span>
<span class="fc" id="L22">                val name = parts[1]</span>
<span class="fc" id="L23">                return PermissionRequirement(name, ScopeRequirement.parse(rawScope))</span>
            }
            catch (e: Exception)
<span class="fc" id="L26">            {</span>
<span class="fc" id="L27">                throw PermissionRequirementParseException(raw)</span>
            }
        }
    }
}

<span class="pc" id="L33">sealed class ScopeRequirement(val value: String)</span>
{
<span class="fc" id="L35">    class Global : ScopeRequirement(&quot;*&quot;)</span>
<span class="pc" id="L36">    class Specific(val prefix: String, val scopeIdUrlKey: String) : ScopeRequirement(&quot;$prefix:&lt;$scopeIdUrlKey&gt;&quot;)</span>

<span class="nc" id="L38">    fun reify(context: ActionContext) = when (this)</span>
    {
<span class="nc bnc" id="L40" title="All 2 branches missed.">        is Global -&gt; Scope.Global()</span>
<span class="nc" id="L41">        is Specific -&gt; Scope.Specific(prefix, context.params(scopeIdUrlKey))</span>
<span class="nc" id="L42">    }</span>

<span class="fc" id="L44">    override fun toString() = value</span>
<span class="fc" id="L45">    override fun equals(other: Any?) = when (other)</span>
    {
<span class="pc bpc" id="L47" title="1 of 2 branches missed.">        is ScopeRequirement -&gt; other.toString() == toString()</span>
<span class="nc" id="L48">        else -&gt; false</span>
<span class="fc" id="L49">    }</span>

<span class="nc" id="L51">    override fun hashCode() = toString().hashCode()</span>

    companion object
    {
        fun parse(rawScope: String): ScopeRequirement
        {
<span class="fc bfc" id="L57" title="All 2 branches covered.">            if (rawScope == &quot;*&quot;)</span>
            {
<span class="fc" id="L59">                return Global()</span>
            }
            else
            {
<span class="fc" id="L63">                val parts = rawScope.split(':')</span>
<span class="fc" id="L64">                val idKey = parts[1]</span>
<span class="pc bpc" id="L65" title="1 of 4 branches missed.">                if (!idKey.startsWith('&lt;') || !idKey.endsWith('&gt;'))</span>
                {
<span class="fc" id="L67">                    throw Exception(&quot;Unable to parse $rawScope as a scope requirement - missing angle brackets from scope ID URL key&quot;)</span>
                }
<span class="fc" id="L69">                return Specific(parts[0], idKey.trim('&lt;', '&gt;'))</span>
            }
        }
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.3.201901230119</span></div></body></html>