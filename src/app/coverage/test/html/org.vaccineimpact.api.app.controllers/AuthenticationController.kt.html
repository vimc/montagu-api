<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>AuthenticationController.kt</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">app</a> &gt; <a href="index.source.html" class="el_package">org.vaccineimpact.api.app.controllers</a> &gt; <span class="el_source">AuthenticationController.kt</span></div><h1>AuthenticationController.kt</h1><pre class="source lang-java linenums">package org.vaccineimpact.api.app.controllers

import org.vaccineimpact.api.app.app_start.Controller
import org.vaccineimpact.api.app.context.ActionContext
import org.vaccineimpact.api.app.logic.RepositoriesUserLogic
import org.vaccineimpact.api.app.logic.UserLogic
import org.vaccineimpact.api.app.repositories.Repositories
import org.vaccineimpact.api.app.requests.FormHelpers
import org.vaccineimpact.api.app.requests.HTMLForm
import org.vaccineimpact.api.app.requests.HTMLFormHelpers
import org.vaccineimpact.api.app.security.internalUser
import org.vaccineimpact.api.models.AuthenticationResponse
import org.vaccineimpact.api.models.FailedAuthentication
import org.vaccineimpact.api.models.SuccessfulAuthentication
import org.vaccineimpact.api.security.*

<span class="fc" id="L17">class AuthenticationController(context: ActionContext,</span>
                               private val userLogic: UserLogic,
                               private val htmlFormHelpers: FormHelpers = HTMLFormHelpers(),
                               private val tokenHelper: WebTokenHelper = WebTokenHelper(KeyHelper.keyPair))
<span class="fc" id="L21">    : Controller(context)</span>
{

<span class="nc" id="L24">    constructor(context: ActionContext, repositories: Repositories)</span>
<span class="nc" id="L25">            : this(context, RepositoriesUserLogic(repositories.user, repositories.modellingGroup, WebTokenHelper(KeyHelper.keyPair)))</span>

    fun authenticate(): AuthenticationResponse
    {
<span class="fc" id="L29">        val validationResult = htmlFormHelpers.checkForm(context,</span>
<span class="fc" id="L30">                mapOf(&quot;grant_type&quot; to &quot;client_credentials&quot;)</span>
        )
<span class="fc" id="L32">        return when (validationResult)</span>
        {
<span class="fc bfc" id="L34" title="All 2 branches covered.">            is HTMLForm.ValidForm -&gt;</span>
            {
<span class="fc" id="L36">                val user = context.userProfile!!.internalUser!!</span>
<span class="fc" id="L37">                val token = userLogic.logInAndGetToken(user).deflated()</span>
<span class="fc" id="L38">                return SuccessfulAuthentication(token, tokenHelper.defaultLifespan)</span>
            }
<span class="fc" id="L40">            is HTMLForm.InvalidForm -&gt; FailedAuthentication(validationResult.problem)</span>
        }
    }

    fun setCookies(): String
    {
<span class="fc" id="L46">        val internalUser = userLogic.getUserByUsername(context.username!!)</span>
<span class="pc bpc" id="L47" title="1 of 2 branches missed.">        val diseasesForUser = (getDiseaseReviewersMap()[context.username!!]</span>
<span class="fc" id="L48">                ?: listOf()) + userLogic.getDiseasesForUser(internalUser)</span>

<span class="fc" id="L50">        val token = tokenHelper.generateToken(internalUser).deflated()</span>
<span class="fc" id="L51">        context.setCookie(CookieName.Main, token)</span>

<span class="fc" id="L53">        val modelReviewToken = tokenHelper.generateModelReviewToken(internalUser, diseasesForUser)</span>
<span class="fc" id="L54">        context.setCookie(CookieName.ModelReview, modelReviewToken)</span>

<span class="fc" id="L56">        return okayResponse()</span>
    }

    fun logOut(): String
    {
<span class="fc" id="L61">        context.setCookie(CookieName.Main, &quot;&quot;)</span>
<span class="fc" id="L62">        context.setCookie(CookieName.ModelReview, &quot;&quot;)</span>
<span class="fc" id="L63">        return okayResponse()</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.3.201901230119</span></div></body></html>