<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>SparkApp.kt</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">app</a> &gt; <a href="index.source.html" class="el_package">org.vaccineimpact.api.app.app_start</a> &gt; <span class="el_source">SparkApp.kt</span></div><h1>SparkApp.kt</h1><pre class="source lang-java linenums">package org.vaccineimpact.api.app.app_start

import org.slf4j.LoggerFactory
import org.vaccineimpact.api.app.ErrorHandler
import org.vaccineimpact.api.app.NotFoundHandler
import org.vaccineimpact.api.app.RequestLogger
import org.vaccineimpact.api.app.addTrailingSlashes
import org.vaccineimpact.api.app.app_start.route_config.MontaguRouteConfig
import org.vaccineimpact.api.app.repositories.RepositoryFactory
import org.vaccineimpact.api.db.Config
import org.vaccineimpact.api.security.KeyHelper
import org.vaccineimpact.api.security.WebTokenHelper
import org.vaccineimpact.api.serialization.MontaguSerializer
import java.io.File
import java.net.BindException
import java.net.ServerSocket
import kotlin.system.exitProcess
import spark.Spark as spk

<span class="nc" id="L20">class MontaguApi</span>
{
<span class="nc" id="L22">    private val urlBase = &quot;/v1&quot;</span>
<span class="nc" id="L23">    private val tokenHelper = WebTokenHelper(KeyHelper.keyPair)</span>

<span class="nc" id="L25">    private val logger = LoggerFactory.getLogger(MontaguApi::class.java)</span>

    fun run(repositoryFactory: RepositoryFactory)
    {
<span class="nc" id="L29">        setupPort()</span>

<span class="nc" id="L31">        spk.redirect.get(&quot;/&quot;, urlBase)</span>

<span class="nc bnc" id="L33" title="All 2 branches missed.">        spk.before(&quot;*&quot;, ::addTrailingSlashes)</span>
<span class="nc" id="L34">        spk.before(&quot;*&quot;, AllowedOriginsFilter(Config.getBool(&quot;allow.localhost&quot;)))</span>

<span class="nc" id="L36">        spk.options(&quot;*&quot;) { _, res -&gt;</span>
<span class="nc" id="L37">            res.header(&quot;Access-Control-Allow-Headers&quot;, &quot;Authorization&quot;)</span>
<span class="nc" id="L38">            res.header(&quot;Access-Control-Allow-Credentials&quot;, &quot;true&quot;)</span>
<span class="nc" id="L39">        }</span>

<span class="nc" id="L41">        RequestLogger.setup(repositoryFactory)</span>
<span class="nc" id="L42">        NotFoundHandler().setup()</span>
<span class="nc" id="L43">        ErrorHandler.setup()</span>

<span class="nc" id="L45">        val router = Router(MontaguRouteConfig, MontaguSerializer.instance, tokenHelper, repositoryFactory)</span>
<span class="nc" id="L46">        router.mapEndpoints(urlBase)</span>

<span class="nc bnc" id="L48" title="All 2 branches missed.">        if (!Config.authEnabled)</span>
        {
<span class="nc" id="L50">            logger.warn(&quot;WARNING: AUTHENTICATION IS DISABLED&quot;)</span>
        }
<span class="nc" id="L52">    }</span>

    private fun setupPort()
    {
<span class="nc bnc" id="L56" title="All 2 branches missed.">        val port = if (Config.authEnabled)</span>
        {
<span class="nc" id="L58">            Config.getInt(&quot;app.port&quot;)</span>
        }
        else
        {
<span class="nc" id="L62">            8888</span>
        }
<span class="nc" id="L64">        var attempts = 5</span>
<span class="nc" id="L65">        spk.port(port)</span>

<span class="nc bnc" id="L67" title="All 4 branches missed.">        while (!isPortAvailable(port) &amp;&amp; attempts &gt; 0)</span>
        {
<span class="nc" id="L69">            logger.info(&quot;Waiting for port $port to be available, $attempts attempts remaining&quot;)</span>
<span class="nc" id="L70">            Thread.sleep(2000)</span>
<span class="nc" id="L71">            attempts--</span>
        }
<span class="nc bnc" id="L73" title="All 2 branches missed.">        if (attempts == 0)</span>
        {
<span class="nc" id="L75">            logger.error(&quot;Unable to bind to port $port - it is already in use.&quot;)</span>
<span class="nc" id="L76">            exitProcess(-1)</span>
        }
<span class="nc" id="L78">    }</span>

    private fun isPortAvailable(port: Int): Boolean
    {
<span class="nc" id="L82">        try</span>
        {
<span class="nc" id="L84">            ServerSocket(port).use {}</span>
<span class="nc" id="L85">            return true</span>
        }
        catch (e: BindException)
<span class="nc" id="L88">        {</span>
<span class="nc" id="L89">            return false</span>
        }
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.3.201901230119</span></div></body></html>