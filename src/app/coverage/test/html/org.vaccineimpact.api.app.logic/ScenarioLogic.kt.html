<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>ScenarioLogic.kt</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">app</a> &gt; <a href="index.source.html" class="el_package">org.vaccineimpact.api.app.logic</a> &gt; <span class="el_source">ScenarioLogic.kt</span></div><h1>ScenarioLogic.kt</h1><pre class="source lang-java linenums">package org.vaccineimpact.api.app.logic

import org.vaccineimpact.api.app.filters.ScenarioFilterParameters
import org.vaccineimpact.api.app.repositories.ModellingGroupRepository
import org.vaccineimpact.api.app.repositories.ScenarioRepository
import org.vaccineimpact.api.app.repositories.TouchstoneRepository
import org.vaccineimpact.api.models.ScenarioAndCoverageSets
import org.vaccineimpact.api.models.ScenarioTouchstoneAndCoverageSets
import org.vaccineimpact.api.models.Scope
import org.vaccineimpact.api.models.TouchstoneVersion

interface ScenarioLogic
{
    fun getScenariosAndCoverageSetsForTouchstone(touchstoneVersionId: String,
                                                 coverageReadingScopes: List&lt;Scope&gt;,
                                                 filterParams: ScenarioFilterParameters)
            : List&lt;ScenarioAndCoverageSets&gt;

    fun getScenarioTouchstoneAndCoverageSets(touchstoneVersion: TouchstoneVersion,
                                             scenarioDescriptionId: String,
                                             coverageReadingScopes: List&lt;Scope&gt;)
            : ScenarioTouchstoneAndCoverageSets
}

<span class="fc" id="L25">class RepositoriesScenarioLogic(private val touchstoneRepo: TouchstoneRepository,</span>
                                private val modellingGroupRepository: ModellingGroupRepository,
                                private val scenarioRepository: ScenarioRepository) : ScenarioLogic
{
    override fun getScenarioTouchstoneAndCoverageSets(touchstoneVersion: TouchstoneVersion,
                                                      scenarioDescriptionId: String,
                                                      coverageReadingScopes: List&lt;Scope&gt;)
            : ScenarioTouchstoneAndCoverageSets
    {
<span class="fc bfc" id="L34" title="All 2 branches covered.">        return if (hasRequiredCoverageReadingScope(touchstoneVersion.id,</span>
<span class="fc" id="L35">                        scenarioDescriptionId,</span>
<span class="fc" id="L36">                        coverageReadingScopes))</span>
        {
            // return coverage with scenario
<span class="fc" id="L39">            val data = touchstoneRepo.getScenarioAndCoverageSets(touchstoneVersion.id, scenarioDescriptionId)</span>
<span class="fc" id="L40">            ScenarioTouchstoneAndCoverageSets(touchstoneVersion, data.scenario, data.coverageSets)</span>
        }
        else
        {
            // return just scenario
<span class="fc" id="L45">            ScenarioTouchstoneAndCoverageSets(touchstoneVersion,</span>
<span class="fc" id="L46">                    scenarioRepository.getScenarioForTouchstone(touchstoneVersion.id, scenarioDescriptionId), null)</span>
        }
    }

    override fun getScenariosAndCoverageSetsForTouchstone(touchstoneVersionId: String,
                                                          coverageReadingScopes: List&lt;Scope&gt;,
                                                          filterParams: ScenarioFilterParameters)
            : List&lt;ScenarioAndCoverageSets&gt;
    {
<span class="fc bfc" id="L55" title="All 2 branches covered.">        return if (coverageReadingScopes.contains(Scope.Global()))</span>
        {
            // return coverage with scenarios
<span class="fc" id="L58">            touchstoneRepo.getScenariosAndCoverageSets(touchstoneVersionId, filterParams)</span>
        }
        else
        {
            // return just scenarios
<span class="fc" id="L63">            scenarioRepository.getScenariosForTouchstone(touchstoneVersionId, filterParams)</span>
<span class="fc" id="L64">                    .map { ScenarioAndCoverageSets(it, null) }</span>
        }
    }

    private fun hasRequiredCoverageReadingScope(touchstoneVersionId: String,
                                                scenarioDescriptionId: String,
                                                scopes: List&lt;Scope&gt;): Boolean
    {
<span class="fc" id="L72">        val groups = modellingGroupRepository.getModellingGroupsForScenario(scenarioDescriptionId,</span>
<span class="fc" id="L73">                touchstoneVersionId)</span>

<span class="fc" id="L75">        val requiredScopes = groups.map {</span>
<span class="fc" id="L76">            Scope.Specific(&quot;modelling-group&quot;, it.id)</span>
<span class="fc" id="L77">        } + Scope.Global()</span>

<span class="fc" id="L79">        return scopes.intersect(requiredScopes).any()</span>
    }

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.3.201901230119</span></div></body></html>